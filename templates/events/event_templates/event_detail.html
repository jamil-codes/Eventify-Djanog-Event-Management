{% extends 'base.html' %}
{% load static thumbnail tz %}

{% block title %}
  {{ event.title }} by {{ event.organizer.name }} - Eventify
{% endblock %}

{% block body %}
  <div class="mx-auto max-w-[1200px] w-[95%] my-12">

    <!-- Event Image -->
    {% if event.image %}
      <figure class="aspect-[16/9] overflow-hidden rounded-xl shadow-lg mb-10">
        {% thumbnail event.image '1200x675' crop='center' as thumb %}
        <img src="{{ thumb.url }}" width="{{ thumb.width }}" height="{{ thumb.height }}" alt="{{ event.title }}" class="object-cover w-full h-full" />
        {% endthumbnail %}
      </figure>
    {% endif %}

    <!-- Title + Organizer Controls -->
    <div class="flex flex-col gap-4 mb-8 md:flex-row md:items-center md:justify-between">
      <h1 class="text-4xl md:text-5xl font-extrabold leading-tight tracking-wide">{{ event.title }}</h1>

      {% if can_add_ticket %}
        <div class="flex flex-wrap gap-2">
          <a href="{% url 'events:edit_event' event.pk %}" class="btn btn-primary btn-sm">Edit Event</a>
          <a href="{% url 'events:delete_event' event.pk %}" class="btn btn-error btn-sm">Delete Event</a>
          <a href="{% url 'events:add_ticket_type' event.pk %}" class="btn btn-secondary btn-sm">Add Ticket Type</a>
        </div>
      {% endif %}
    </div>

    <!-- Event Info -->
    <div class="mb-10 text-lg space-y-3">
      <p class="flex items-center gap-2">
        <span class="font-medium">üìç Location:</span> {{ event.location }}
      </p>
      <div>
        <p class="flex items-center gap-2">
          <span class="font-medium">üóì Date & Time:</span>
          {% timezone event.organizer.timezone %}
            {{ event.start_time|date:'M d, Y ¬∑ H:i' }}
          {% endtimezone %}
          <span class="text-sm text-base-content/70">({{ event.organizer.timezone }})</span>
        </p>

        {% if request.user.is_authenticated and request.user.timezone != event.organizer.timezone %}
          <p class="pl-6 text-sm text-base-content/60 mt-1">
            Your local:
            {% timezone request.user.timezone %}
              {{ event.start_time|date:'M d, Y ¬∑ H:i' }}
            {% endtimezone %}
            <span class="text-xs text-base-content/50">({{ request.user.timezone }})</span>
          </p>
        {% endif %}
      </div>
    </div>

    <!-- Description -->
    <div class="prose max-w-none mb-14">
      {{ event.description|linebreaks }}
    </div>

    <!-- Organizer -->
    <div class="flex items-center gap-4 pt-6 border-t border-base-200">
      <a href="{% url 'authentication:profile' event.organizer.username %}" class="flex items-center gap-3 p-2 -m-2 rounded-md transition hover:bg-base-200/40">
        <div class="avatar">
          <div class="w-12 h-12 rounded-full">
            {% if event.organizer.profile_pic %}
              {% thumbnail event.organizer.profile_pic '48x48' crop='center' as thumb %}
                <img src="{{ thumb.url }}" alt="{{ event.organizer.name }}" />
              {% endthumbnail %}
            {% else %}
              <img src="{% static 'images/default-profile.webp' %}" alt="Default profile" />
            {% endif %}
          </div>
        </div>
        <div>
          <p class="text-base font-semibold">{{ event.organizer.name }}</p>
          <p class="text-sm text-base-content/70">{{ event.organizer.tagline|default:'Organizer' }}</p>
        </div>
      </a>
    </div>

    <!-- Tickets -->
    <div class="border-t border-base-300 my-14"></div>

    {% if ticket_types %}
      <div class="w-full mx-auto mt-12">
        <h2 class="text-3xl font-bold mb-10 text-center">Available Tickets</h2>

        <div class="grid gap-8 justify-center items-start grid-cols-[repeat(auto-fit,minmax(280px,1fr))]">
          {% for ticket_type in ticket_types %}
            <div class="card bg-base-200 border border-base-300 shadow-md hover:shadow-xl transition transform hover:-translate-y-1">
              <div class="card-body flex flex-col text-center">
                <h2 class="text-sm font-medium uppercase tracking-wide text-primary">{{ ticket_type.name }}</h2>
                <h1 class="text-4xl font-bold my-4">${{ ticket_type.price }}</h1>
                <p class="text-base flex-1">{{ ticket_type.description|default:'No description provided.' }}</p>

                <p class="mt-4 text-sm">
                  {% if ticket_type.quantity_available == 0 %}
                    <span class="font-semibold text-error">Sold Out</span>
                  {% elif ticket_type.quantity_available < 10 %}
                    <span class="font-semibold text-warning">Only {{ ticket_type.quantity_available }} left!</span>
                  {% else %}
                    <span class="text-success">{{ ticket_type.quantity_available }} available</span>
                  {% endif %}
                </p>

                <!-- Actions -->
                <div class="mt-6 flex flex-col gap-2">
                  {% if ticket_type.quantity_available > 0 %}
                    <a href="{% url 'events:buy_ticket' event.pk ticket_type.pk %}"
                       class="btn {% if request.user == event.organizer %}btn-warning{% else %}btn-success{% endif %} w-full">
                      {% if request.user == event.organizer %}
                        Claim Ticket
                      {% else %}
                        Buy Now
                      {% endif %}
                    </a>
                  {% else %}
                    <button class="btn btn-disabled w-full">Sold Out</button>
                  {% endif %}

                  {% if can_add_ticket %}
                    <div class="flex gap-2 mt-4">
                      <a href="{% url 'events:edit_ticket_type' event.pk ticket_type.pk %}" class="btn btn-primary btn-sm flex-1">Edit</a>
                      <a href="{% url 'events:delete_ticket_type' event.pk ticket_type.pk %}" class="btn btn-error btn-sm flex-1">Delete</a>
                    </div>
                  {% endif %}
                </div>
              </div>
            </div>
          {% endfor %}
        </div>
      </div>
    {% else %}
      <p class="mt-10 text-center text-base-content/70">No tickets available for this event.</p>
      {% if can_add_ticket %}
        <div class="mt-6 text-center">
          <a href="{% url 'events:add_ticket_type' event.pk %}" class="btn btn-secondary">+ Add Ticket Type</a>
        </div>
      {% endif %}
    {% endif %}
  </div>
{% endblock %}
